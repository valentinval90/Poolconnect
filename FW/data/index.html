<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>Pool Connect</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

  <!-- LOGIN SCREEN -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <div class="login-header">
		<img src="logo.png" class="logo-img">
      </div>

      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label for="username">ğŸ‘¤ Nom d'utilisateur</label>
          <input type="text" id="username" placeholder="Entrez votre identifiant" required autocomplete="username">
        </div>

        <div class="form-group">
          <label for="loginPassword">ğŸ”’ Mot de passe</label>
          <input type="password" id="loginPassword" placeholder="Entrez votre mot de passe" required autocomplete="current-password">
        </div>

        <button type="submit" class="login-btn">
          Se connecter
        </button>

        <div class="login-error" id="loginError">
          âŒ Identifiants incorrects. Veuillez rÃ©essayer.
        </div>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app-container" id="appContainer">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="logo">
		<img src="logo.png" class="logo-img">
        <div class="led-indicator" id="ledStatus">
          <div class="led-dot"></div>
          <span>SystÃ¨me actif</span>
        </div>
      </div>
      
      <div class="info-card">
        <div class="datetime" id="datetime">ğŸ•’ Chargement...</div>
        <div class="temperature" id="temperature">--Â°C</div>
        <div class="temp-label">TempÃ©rature de l'eau</div>
        
        <div class="filtration-info">
          <div class="filtration-row">
            <span>â±ï¸ Temps recommandÃ©</span>
            <span class="value" id="tempsFiltrationRecommande">--</span>
          </div>
          <div class="filtration-row">
            <span>âš™ï¸ Temps en cours</span>
            <span class="value" id="tempsFiltrationActuel">--</span>
          </div>
        </div>
      </div>

      <!-- NAVIGATION TABS -->
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard')">
          <span class="icon">ğŸ </span>
          <span>Accueil</span>
        </button>
        <button class="nav-tab" onclick="showTab('control')">
          <span class="icon">ğŸ®</span>
          <span>ContrÃ´le</span>
        </button>
        <button class="nav-tab" onclick="showTab('timers')">
          <span class="icon">â°</span>
          <span>Timers</span>
        </button>
		<button class="nav-tab" onclick="showTab('calibration')">
		  <span class="icon">ğŸ¯</span>
		  <span>Ã‰talonnage</span>
		</button>
        <button class="nav-tab" onclick="showTab('settings')">
          <span class="icon">âš™ï¸</span>
          <span>ParamÃ¨tres</span>
        </button>
        <button class="nav-tab" onclick="showTab('users')" id="usersTab" style="display: none;">
          <span class="icon">ğŸ‘¥</span>
          <span>Utilisateurs</span>
        </button>
      </div>
        
      <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="changePassword()">ğŸ”’ Changer mot de passe</button>
      <button class="logout-btn" id="logoutBtn">ğŸšª DÃ©connexion</button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      
      <!-- DASHBOARD TAB -->
      <div id="tab-dashboard" class="tab-content active">
        <h1 class="page-title">ğŸ  Tableau de bord</h1>
        
        <div class="dashboard-grid">
          
          <!-- Quick Stats -->
          <div class="stat-card">
            <div class="stat-icon">ğŸŒ¡ï¸</div>
            <div class="stat-content">
              <div class="stat-label">TempÃ©rature Eau</div>
              <div class="stat-value" id="dash-water-temp">--Â°C</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">ğŸ’ª</div>
            <div class="stat-content">
              <div class="stat-label">Pression Filtre</div>
              <div class="stat-value" id="dash-pressure">-- bar</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">â˜€ï¸</div>
            <div class="stat-content">
              <div class="stat-label">TempÃ©rature Ext.</div>
              <div class="stat-value" id="dash-ext-temp">--Â°C</div>
            </div>
          </div>

          <div class="stat-card" id="leak-card">
            <div class="stat-icon">ğŸ’§</div>
            <div class="stat-content">
              <div class="stat-label">Ã‰tat SystÃ¨me</div>
              <div class="stat-value" id="dash-leak">OK</div>
            </div>
          </div>

        </div>

        <!-- Equipment Status -->
        <div class="card">
          <div class="card-header">
            <h2>âš¡ Ã‰tat des Ã©quipements</h2>
          </div>
          <div class="equipment-status">
            <div class="equipment-item">
              <span class="equipment-icon">ğŸ’§</span>
              <span class="equipment-name">Pompe</span>
              <span class="equipment-state" id="eq-pompe">ArrÃªtÃ©e</span>
            </div>
            <div class="equipment-item">
              <span class="equipment-icon">âš¡</span>
              <span class="equipment-name">Ã‰lectrolyseur</span>
              <span class="equipment-state" id="eq-electro">ArrÃªtÃ©</span>
            </div>
            <div class="equipment-item">
              <span class="equipment-icon">ğŸ’¡</span>
              <span class="equipment-name">Lampe</span>
              <span class="equipment-state" id="eq-lampe">Ã‰teinte</span>
            </div>
            <div class="equipment-item">
              <span class="equipment-icon">ğŸš°</span>
              <span class="equipment-name">Ã‰lectrovalve</span>
              <span class="equipment-state" id="eq-valve">FermÃ©e</span>
            </div>
            <div class="equipment-item">
              <span class="equipment-icon">ğŸ”¥</span>
              <span class="equipment-name">Pompe Ã  Chaleur</span>
              <span class="equipment-state" id="eq-pac">ArrÃªtÃ©e</span>
            </div>
          </div>
        </div>

        <!-- Active Timers -->
        <div class="card">
          <div class="card-header">
            <h2>â° Timers actifs</h2>
            <span class="badge success" id="active-timers-count">0</span>
          </div>
          <div id="active-timers-list">
            <p style="text-align: center; color: #999; padding: 20px;">Aucun timer actif</p>
          </div>
        </div>

        <!-- Recent History -->
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“Š Historique rÃ©cent</h2>
          </div>
          <div class="history-list" id="dash-history">
            <p style="text-align: center; color: #999; padding: 20px;">Chargement...</p>
          </div>
        </div>

        <!-- GRAPHIQUE JOURNALIER -->
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“ˆ Graphique Journalier</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
              <button class="btn btn-sm" onclick="refreshChart()">ğŸ”„ Actualiser</button>
              <span class="badge success" id="chart-points">0 points</span>
            </div>
          </div>
          <div style="position: relative; height: 400px; padding: 20px;">
            <canvas id="dailyChart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item"><span class="dot" style="background: #3498db;"></span> TempÃ©rature Eau (Â°C)</div>
            <div class="legend-item"><span class="dot" style="background: #27ae60;"></span> Pression (bar x10)</div>
            <div class="legend-item"><span class="dot" style="background: #e67e22;"></span> Volet Ouvert</div>
            <div class="legend-item"><span class="dot" style="background: #00bcd4;"></span> Ã‰lectrovalve</div>
            <div class="legend-item"><span class="dot" style="background: #e74c3c;"></span> PAC Active</div>
            <div class="legend-item"><span class="dot" style="background: #9b59b6;"></span> Timers Actifs</div>
          </div>
		  <div class="chart-controls" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
			  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
				<button class="btn btn-sm" onclick="exportChartDataCSV()">ğŸ“¥ Export CSV</button>
				<button class="btn btn-sm" onclick="calculateChartStats()">ğŸ“Š Statistiques</button>
				<button class="btn btn-sm" onclick="predictTemperature(2)">ğŸ”® PrÃ©diction 2h</button>
				<button class="btn btn-sm" onclick="addChartEvent(prompt('Nom Ã©vÃ©nement:'), '#e74c3c')">ğŸ“Œ Marquer Ã©vÃ©nement</button>
				<button class="btn btn-sm" onclick="zoomToTimeRange(6, 12)">ğŸ” Zoom 6h-12h</button>
				<button class="btn btn-sm" onclick="zoomToTimeRange(12, 18)">ğŸ” Zoom 12h-18h</button>
				<button class="btn btn-sm" onclick="zoomToTimeRange(18, 23)">ğŸ” Zoom 18h-23h</button>
				<button class="btn btn-sm" onclick="resetZoom()">â†©ï¸ Vue complÃ¨te</button>
				<button class="btn btn-sm" onclick="loadComparisonData(1)">ğŸ“… Comparer hier</button>
				<button class="btn btn-sm" onclick="loadComparisonData(7)">ğŸ“… Comparer -7j</button>
				<button class="btn btn-sm" onclick="clearComparison()">âŒ Effacer comparaison</button>
				<button class="btn btn-sm" onclick="addMovingAverage(30)">ğŸ“ˆ Moyenne 30min</button>
			  </div>
		  </div>
        </div>
		
	  </div>
      <!-- CONTROL TAB -->
      <div id="tab-control" class="tab-content">
        <h1 class="page-title">ğŸ® ContrÃ´le des Ã©quipements</h1>

        <div class="control-grid">
          
          <div class="control-card">
            <div class="control-header">
              <span class="control-icon">ğŸ’§</span>
              <h3>Pompe de Filtration</h3>
            </div>
            <div class="control-body">
              <p>Filtration et circulation de l'eau</p>
              <label class="switch-large">
                <input type="checkbox" id="ctrl-relay0" onchange="toggleRelay(0, this.checked)">
                <span class="slider-large"></span>
              </label>
            </div>
          </div>

          <div class="control-card">
            <div class="control-header">
              <span class="control-icon">âš¡</span>
              <h3>Ã‰lectrolyseur</h3>
            </div>
            <div class="control-body">
              <p>Production de chlore automatique</p>
              <label class="switch-large">
                <input type="checkbox" id="ctrl-relay1" onchange="toggleRelay(1, this.checked)">
                <span class="slider-large"></span>
              </label>
            </div>
          </div>

          <div class="control-card">
            <div class="control-header">
              <span class="control-icon">ğŸ’¡</span>
              <h3>Ã‰clairage</h3>
            </div>
            <div class="control-body">
              <p>Lampe LED de la piscine</p>
              <label class="switch-large">
                <input type="checkbox" id="ctrl-relay2" onchange="toggleRelay(2, this.checked)">
                <span class="slider-large"></span>
              </label>
            </div>
          </div>

          <div class="control-card">
            <div class="control-header">
              <span class="control-icon">ğŸš°</span>
              <h3>Ã‰lectrovalve</h3>
            </div>
            <div class="control-body">
              <p>ContrÃ´le du remplissage d'eau</p>
              <label class="switch-large">
                <input type="checkbox" id="ctrl-relay3" onchange="toggleRelay(3, this.checked)">
                <span class="slider-large"></span>
              </label>
            </div>
          </div>

          <div class="control-card">
            <div class="control-header">
              <span class="control-icon">ğŸ”¥</span>
              <h3>Pompe Ã  Chaleur</h3>
            </div>
            <div class="control-body">
              <p>Chauffage de l'eau</p>
              <label class="switch-large">
                <input type="checkbox" id="ctrl-relay4" onchange="toggleRelay(4, this.checked)">
                <span class="slider-large"></span>
              </label>
            </div>
          </div>

          <div class="control-card sensor-card">
            <div class="control-header">
              <span class="control-icon">ğŸ“Š</span>
              <h3>Capteurs</h3>
            </div>
            <div class="control-body">
              <div class="sensor-grid">
                <div class="sensor-item">
                  <span>ğŸšï¸ Volet</span>
                  <strong id="ctrl-volet">--</strong>
                </div>
                <div class="sensor-item">
                  <span>ğŸ’§ Fuite</span>
                  <strong id="ctrl-fuite">--</strong>
                </div>
                <div class="sensor-item">
                  <span>ğŸ“Š Buzzer</span>
                  <label class="switch">
                    <input type="checkbox" checked id="ctrl-buzzer" onchange="toggleBuzzer(this.checked)">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- TIMERS TAB - VERSION FLEXIBLE v4.0 -->
      <div id="tab-timers" class="tab-content">
        <h1 class="page-title">â° Gestion des Timers Flexibles</h1>

        <div class="timers-layout-flex">         
          <!-- Liste des timers -->
          <div class="card">
            <div class="card-header">
				<h2>ğŸ“‹ Timers configurÃ©s</h2>
				<div style="display: flex; gap: 10px; align-items: center;">
					<button class="btn" onclick="showScenariosModal()">ğŸ¯ ScÃ©narios</button>
					<span class="badge success" id="timer-count-badge">0</span>
					<button class="btn btn-success" onclick="showTimerEditor(null)">
					  â• Nouveau Timer
					</button>
				</div>
			</div>
          </div>
          <div class="timer-flex-list" id="timerFlexList">
              <p style="text-align: center; color: #999; padding: 20px;">Aucun timer configurÃ©</p>
          </div>
        </div>

      </div>

	  <!-- CALIBRATION TAB -->
	  <div id="tab-calibration" class="tab-content">
		  <h1 class="page-title">ğŸ¯ Ã‰talonnage des capteurs</h1>
		  <!-- Vue d'ensemble -->
		  <div class="card">
			<div class="card-header">
			  <h2>ğŸ“Š Ã‰tat des Ã©talonnages</h2>
			</div>
			
			<div class="calibration-overview">
			  <!-- TempÃ©rature -->
			  <div class="calib-sensor-card">
				<div class="calib-sensor-icon">ğŸŒ¡ï¸</div>
				<div class="calib-sensor-info">
				  <h3>TempÃ©rature de l'eau</h3>
				  <div class="calib-status inactive" id="calib-temp-status">âŒ DÃ©sactivÃ©</div>
				  <div class="calib-current-value">
					Valeur actuelle: <strong id="calib-current-temp-raw">--</strong> Â°C
				  </div>
				</div>
				<div class="calib-sensor-actions">
				  <button class="btn btn-success" onclick="startCalibrationAssistant('temp')">
					ğŸš€ Lancer assistant
				  </button>
				  <button class="btn btn-danger" onclick="disableCalibration('temp')">
					âŒ DÃ©sactiver
				  </button>
				</div>
			  </div>

			  <!-- Pression -->
			  <div class="calib-sensor-card">
				<div class="calib-sensor-icon">ğŸ’ª</div>
				<div class="calib-sensor-info">
				  <h3>Pression de filtration</h3>
				  <div class="calib-status inactive" id="calib-pressure-status">âŒ DÃ©sactivÃ©</div>
				  <div class="calib-current-value">
					Valeur actuelle: <strong id="calib-current-pressure-raw">--</strong> bar
				  </div>
				</div>
				<div class="calib-sensor-actions">
				  <button class="btn btn-success" onclick="startCalibrationAssistant('pressure')">
					ğŸš€ Lancer assistant
				  </button>
				  <button class="btn btn-danger" onclick="disableCalibration('pressure')">
					âŒ DÃ©sactiver
				  </button>
				</div>
			  </div>
			</div>
		  </div>

		  <!-- Guide rapide -->
		  <div class="card">
			<div class="card-header">
			  <h2>â„¹ï¸ Guide d'Ã©talonnage</h2>
			</div>
			<div class="guide-content">
			  <div class="guide-step">
				<span class="guide-number">1</span>
				<div class="guide-text">
				  <strong>PrÃ©parez votre Ã©quipement de rÃ©fÃ©rence</strong>
				  <p>ThermomÃ¨tre calibrÃ© ou manomÃ¨tre de prÃ©cision</p>
				</div>
			  </div>
			  <div class="guide-step">
				<span class="guide-number">2</span>
				<div class="guide-text">
				  <strong>Lancez l'assistant d'Ã©talonnage</strong>
				  <p>Suivez les instructions Ã©tape par Ã©tape</p>
				</div>
			  </div>
			  <div class="guide-step">
				<span class="guide-number">3</span>
				<div class="guide-text">
				  <strong>Prenez vos mesures</strong>
				  <p>Comparez avec votre Ã©quipement de rÃ©fÃ©rence</p>
				</div>
			  </div>
			  <div class="guide-step">
				<span class="guide-number">4</span>
				<div class="guide-text">
				  <strong>Validez et testez</strong>
				  <p>VÃ©rifiez la prÃ©cision aprÃ¨s Ã©talonnage</p>
				</div>
			  </div>
			</div>
		  </div>
	  </div>

      <!-- SETTINGS TAB -->
      <div id="tab-settings" class="tab-content">
        <h1 class="page-title">âš™ï¸ ParamÃ¨tres du systÃ¨me</h1>

        <div class="settings-grid">

          <!-- MQTT Configuration -->
          <div class="card">
            <div class="card-header">
              <h2>ğŸ“¡ Configuration MQTT</h2>
              <span class="badge" id="mqtt-status-badge">DÃ©connectÃ©</span>
            </div>

            <form id="mqttForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="mqtt-server">ğŸŒ Serveur</label>
                  <input type="text" id="mqtt-server" placeholder="192.168.1.100">
                </div>

                <div class="form-group">
                  <label for="mqtt-port">ğŸ”Œ Port</label>
                  <input type="number" id="mqtt-port" placeholder="1883" value="1883">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="mqtt-user">ğŸ‘¤ Utilisateur</label>
                  <input type="text" id="mqtt-user" placeholder="username">
                </div>

                <div class="form-group">
                  <label for="mqtt-password">ğŸ”’ Mot de passe</label>
                  <input type="password" id="mqtt-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
              </div>

              <div class="form-group">
                <label for="mqtt-topic">ğŸ“® Topic</label>
                <input type="text" id="mqtt-topic" placeholder="pool/control" value="pool/control">
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-success">ğŸ’¾ Sauvegarder MQTT</button>
                <button type="button" class="btn" onclick="testMQTT()">ğŸ”Œ Tester connexion</button>
                <button type="button" class="btn" onclick="rediscoverHomeAssistant()">ğŸ  Republier HA</button>
              </div>
            </form>
          </div>

          <!-- Weather Configuration -->
          <div class="card">
            <div class="card-header">
              <h2>ğŸŒ¦ï¸ Configuration MÃ©tÃ©o</h2>
            </div>

            <form id="weatherForm">
              <div class="form-group">
                <label for="weather-api">ğŸ”‘ ClÃ© API OpenWeatherMap</label>
                <input type="text" id="weather-api" placeholder="Votre clÃ© API">
                <small>Obtenez une clÃ© gratuite sur <a href="https://openweathermap.org/api" target="_blank">openweathermap.org</a></small>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="weather-lat">ğŸ“ Latitude</label>
                  <input type="text" id="weather-lat" placeholder="47.666672">
                </div>

                <div class="form-group">
                  <label for="weather-lon">ğŸ“ Longitude</label>
                  <input type="text" id="weather-lon" placeholder="6.85">
                </div>
              </div>

              <button type="submit" class="btn btn-success btn-block">ğŸ’¾ Sauvegarder MÃ©tÃ©o</button>
            </form>
          </div>

		  <!-- Configuration Graphique -->
		  <div class="card">
			  <div class="card-header">
				<h2>ğŸ“Š Configuration Graphique</h2>
			  </div>

			  <div class="form-group">
				<label for="chart-interval-select">â±ï¸ Intervalle de mise Ã  jour</label>
				<select id="chart-interval-select" style="width: 100%;">
				  <option value="60000">1 minute (max 1440 points)</option>
				  <option value="120000">2 minutes (max 720 points)</option>
				  <option value="300000" selected>5 minutes (max 288 points)</option>
				  <option value="600000">10 minutes (max 144 points)</option>
				  <option value="900000">15 minutes (max 96 points)</option>
				  <option value="1800000">30 minutes (max 48 points)</option>
				</select>
				<small>
				  Intervalle actuel: <strong id="current-chart-interval">5 minutes</strong>
				  <br>
				  âš ï¸ Un intervalle court gÃ©nÃ¨re plus de points mais consomme plus de mÃ©moire
				</small>
			  </div>

			  <div class="info-text" style="margin-top: 15px;">
				<strong>ğŸ’¡ Conseils:</strong>
				<ul style="margin-top: 10px; padding-left: 20px;">
				  <li>1-2 min: Suivi dÃ©taillÃ© Ã  court terme</li>
				  <li>5 min: Ã‰quilibre idÃ©al (recommandÃ©)</li>
				  <li>10-15 min: Ã‰conomie mÃ©moire</li>
				  <li>30 min: Vue d'ensemble long terme</li>
				</ul>
			  </div>
		  </div>

		  <!-- System Configuration -->
          <div class="card">
            <div class="card-header">
              <h2>ğŸ”§ Configuration SystÃ¨me</h2>
            </div>

            <form id="systemForm">
              <div class="form-group">
                <label for="pressure-threshold">ğŸ’ª Seuil de pression (bar)</label>
                <input type="number" step="0.1" id="pressure-threshold" value="2.0">
                <small>Alarme si la pression dÃ©passe ce seuil</small>
              </div>

              <div class="form-group">
                <label>ğŸ“Š Buzzer</label>
                <label class="switch">
                  <input type="checkbox" checked id="buzzer-enabled">
                  <span class="slider"></span>
                </label>
                <small>Activer/dÃ©sactiver le buzzer d'alarme</small>
              </div>

              <button type="submit" class="btn btn-success btn-block">ğŸ’¾ Sauvegarder SystÃ¨me</button>
            </form>
          </div>

          <!-- System Info -->
          <div class="card">
            <div class="card-header">
              <h2>â„¹ï¸ Informations SystÃ¨me</h2>
            </div>
            
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Version Firmware</span>
                <span class="info-value" id="sys-version">--</span>
              </div>
              <div class="info-item">
                <span class="info-label">Adresse IP</span>
                <span class="info-value" id="sys-ip">--</span>
              </div>
              <div class="info-item">
                <span class="info-label">Uptime</span>
                <span class="info-value" id="sys-uptime">--</span>
              </div>
              <div class="info-item">
                <span class="info-label">MÃ©moire Libre</span>
                <span class="info-value" id="sys-heap">--</span>
              </div>
            </div>
            
            <div class="form-actions" style="margin-top: 20px;">
              <button class="btn" onclick="window.location.href='/update'">ğŸ”„ Mise Ã  jour OTA</button>
              <button class="btn btn-danger" onclick="restartSystem()">ğŸ”„ RedÃ©marrer</button>
            </div>
          </div>
		  
		  <div class="card">
			  <div class="card-header">
				<h2>ğŸ’¾ Sauvegarde & Restauration</h2>
			  </div>
			  
			  <div class="info-text" style="margin-bottom: 20px;">
				â„¹ï¸ Sauvegardez votre configuration complÃ¨te (utilisateurs, timers, calibration, etc.)
			  </div>
			  
			  <div class="form-actions">
				<button class="btn btn-success" onclick="downloadBackup()">
				  ğŸ“¥ TÃ©lÃ©charger Backup
				</button>
				<button class="btn" onclick="uploadBackup()">
				  ğŸ“¤ Restaurer Backup
				</button>
				<button class="btn" onclick="saveBackupToESP()">
				  ğŸ’¾ Sauver sur ESP32
				</button>
			  </div>
			  
			  <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
				ğŸ”„ Backup automatique quotidien activÃ©
			  </p>
		  </div>

        </div>
      </div>

      <!-- USERS TAB (Admin only) -->
      <div id="tab-users" class="tab-content">
        <h1 class="page-title">ğŸ‘¥ Gestion des utilisateurs</h1>

        <div class="users-layout">
          
          <div class="card">
            <div class="card-header">
              <h2>ğŸ‘¥ Utilisateurs configurÃ©s</h2>
              <span class="badge success" id="user-count-badge">0</span>
            </div>
            <div class="users-list" id="usersList">
              <p style="text-align: center; color: #999; padding: 20px;">Chargement...</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2>â• Nouvel utilisateur</h2>
            </div>

            <form id="userForm">
              <div class="form-group">
                <label for="user-username">ğŸ‘¤ Nom d'utilisateur</label>
                <input type="text" id="user-username" placeholder="Ex: john" required>
              </div>

              <div class="form-group">
                <label for="user-password">ğŸ”’ Mot de passe</label>
                <input type="password" id="user-password" placeholder="Minimum 6 caractÃ¨res" required minlength="6">
              </div>

              <div class="form-group">
                <label for="user-role">ğŸ­ RÃ´le</label>
                <select id="user-role">
                  <option value="user">Utilisateur</option>
                  <option value="admin">Administrateur</option>
                </select>
                <small>Les administrateurs peuvent gÃ©rer les utilisateurs</small>
              </div>

              <button type="submit" class="btn btn-success btn-block">
                â• Ajouter l'utilisateur
              </button>
            </form>
          </div>

        </div>
      </div>

    </div>
  </div>

<!-- ============================================================================ -->
<!-- MODALS POUR TIMERS FLEXIBLES -->
<!-- ============================================================================ -->

<!-- Modal Ã‰diteur de Timer -->
<div class="modal" id="timerEditorModal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2 id="timerEditorTitle">â• Nouveau Timer</h2>
      <button class="close-btn" onclick="closeTimerEditor()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <!-- Onglets -->
      <div class="editor-tabs">
        <button class="editor-tab active" onclick="showEditorTab('config')">âš™ï¸ Configuration</button>
        <button class="editor-tab" onclick="showEditorTab('conditions')">ğŸ” Conditions</button>
        <button class="editor-tab" onclick="showEditorTab('actions')">ğŸ¬ Actions</button>
        <button class="editor-tab" onclick="showEditorTab('preview')">ğŸ‘ï¸ AperÃ§u</button>
      </div>
      
      <!-- Onglet Configuration -->
      <div id="editor-config" class="editor-tab-content active">
        <div class="form-group">
          <label>ğŸ“ Nom du Timer</label>
          <input type="text" id="edit-timer-name" placeholder="Ex: Filtration Ã‰tÃ©" required>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="edit-timer-enabled" checked>
            <span>âœ… Timer activÃ©</span>
          </label>
        </div>
        
        <div class="form-group">
          <label>ğŸ“… Jours d'exÃ©cution</label>
          <div class="days-container">
            <button type="button" class="day-btn" data-day="0" onclick="toggleDay(this)">Dim</button>
            <button type="button" class="day-btn active" data-day="1" onclick="toggleDay(this)">Lun</button>
            <button type="button" class="day-btn active" data-day="2" onclick="toggleDay(this)">Mar</button>
            <button type="button" class="day-btn active" data-day="3" onclick="toggleDay(this)">Mer</button>
            <button type="button" class="day-btn active" data-day="4" onclick="toggleDay(this)">Jeu</button>
            <button type="button" class="day-btn active" data-day="5" onclick="toggleDay(this)">Ven</button>
            <button type="button" class="day-btn" data-day="6" onclick="toggleDay(this)">Sam</button>
          </div>
        </div>
        
        <div class="form-group">
          <label>ğŸ• Heure de dÃ©marrage</label>
          <div class="start-time-selector">
            <select id="edit-start-type" onchange="updateStartTimeInputs()">
              <option value="0">Heure fixe</option>
              <option value="1">Lever du soleil</option>
              <option value="2">Coucher du soleil</option>
            </select>
            <div id="fixed-time-inputs">
              <input type="number" id="edit-start-hour" min="0" max="23" value="9" style="width: 70px;">
              <span>:</span>
              <input type="number" id="edit-start-minute" min="0" max="59" value="0" style="width: 70px;">
            </div>
            <div id="sun-offset-input" style="display: none;">
              <span>DÃ©calage:</span>
              <input type="number" id="edit-sun-offset" value="0" style="width: 80px;">
              <span>minutes</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Onglet Conditions -->
      <div id="editor-conditions" class="editor-tab-content">
        <p class="info-text">âš ï¸ Le timer ne dÃ©marrera que si toutes les conditions cochÃ©es sont remplies</p>
        
        <div class="conditions-list">
          <div class="condition-item">
            <label>
              <input type="checkbox" id="cond-cover-open">
              <span>ğŸšï¸ Volet doit Ãªtre ouvert</span>
            </label>
          </div>
          
          <div class="condition-item">
            <label>
              <input type="checkbox" id="cond-temp-min">
              <span>ğŸŒ¡ï¸ TempÃ©rature eau minimum:</span>
            </label>
            <input type="number" id="cond-temp-min-val" step="0.1" value="15" style="width: 80px;">
            <span>Â°C</span>
          </div>
          
          <div class="condition-item">
            <label>
              <input type="checkbox" id="cond-temp-max">
              <span>ğŸŒ¡ï¸ TempÃ©rature eau maximum:</span>
            </label>
            <input type="number" id="cond-temp-max-val" step="0.1" value="30" style="width: 80px;">
            <span>Â°C</span>
          </div>
          
          <div class="condition-item">
            <label>
              <input type="checkbox" id="cond-ext-temp-min">
              <span>â˜€ï¸ TempÃ©rature extÃ©rieure minimum:</span>
            </label>
            <input type="number" id="cond-ext-temp-min-val" step="0.1" value="10" style="width: 80px;">
            <span>Â°C</span>
          </div>
          
          <div class="condition-item">
            <label>
              <input type="checkbox" id="cond-pressure-min">
              <span>ğŸ’ª Pression minimum:</span>
            </label>
            <input type="number" id="cond-pressure-min-val" step="0.1" value="1.0" style="width: 80px;">
            <span>bar</span>
          </div>
          
          <div class="condition-item">
            <label>
              <input type="checkbox" id="cond-no-leak" checked disabled>
              <span>ğŸ’§ Pas de fuite (obligatoire)</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Onglet Actions -->
      <div id="editor-actions" class="editor-tab-content">
        <div class="actions-header">
          <p class="info-text">ğŸ¬ Actions Ã  exÃ©cuter dans l'ordre</p>
          <button class="btn btn-success" onclick="showActionSelector()">â• Ajouter une action</button>
        </div>
        
        <div class="actions-list" id="actionsList">
          <p style="text-align: center; color: #999; padding: 30px;">Aucune action. Cliquez sur "Ajouter une action" pour commencer.</p>
        </div>
      </div>
      
      <!-- Onglet AperÃ§u -->
      <div id="editor-preview" class="editor-tab-content">
        <div class="preview-container" id="timerPreview">
          <!-- GÃ©nÃ©rÃ© dynamiquement -->
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn" onclick="closeTimerEditor()">Annuler</button>
      <button class="btn btn-success" onclick="saveTimer()">ğŸ’¾ Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Modal SÃ©lecteur d'Action -->
<div class="modal" id="actionSelectorModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Choisir une action</h2>
      <button class="close-btn" onclick="closeActionSelector()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <div class="action-types-grid">
        <div class="action-type-card" onclick="addActionType('relay')">
          <div class="action-type-icon">âš¡</div>
          <div class="action-type-name">Relais ON/OFF</div>
          <div class="action-type-desc">Activer ou dÃ©sactiver un Ã©quipement</div>
        </div>
        
        <div class="action-type-card" onclick="addActionType('wait')">
          <div class="action-type-icon">â±ï¸</div>
          <div class="action-type-name">Attendre</div>
          <div class="action-type-desc">Pause avant l'action suivante</div>
        </div>
        
        <div class="action-type-card" onclick="addActionType('measure')">
          <div class="action-type-icon">ğŸŒ¡ï¸</div>
          <div class="action-type-name">Mesurer TempÃ©rature</div>
          <div class="action-type-desc">AprÃ¨s 15min de pompe</div>
        </div>
        
        <div class="action-type-card" onclick="addActionType('auto')">
          <div class="action-type-icon">ğŸ”„</div>
          <div class="action-type-name">DurÃ©e Auto</div>
          <div class="action-type-desc">TempÃ©rature / 2 heures</div>
        </div>
		
		<div class="action-type-card" onclick="addActionType('buzzer')">
		  <div class="action-type-icon">ğŸ”Š</div>
		  <div class="action-type-name">Buzzer</div>
		  <div class="action-type-desc">Signal sonore (bips ou alarme)</div>
		</div>

		<div class="action-type-card" onclick="addActionType('led')">
		  <div class="action-type-icon">ğŸ’¡</div>
		  <div class="action-type-name">LED</div>
		  <div class="action-type-desc">ContrÃ´le de la LED de statut</div>
		</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Assistant Ã‰talonnage -->
<div class="modal" id="calibAssistantModal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2 id="calib-assistant-title">ğŸ¯ Assistant Ã‰talonnage</h2>
      <button class="close-btn" onclick="closeCalibrationAssistant()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <!-- Barre de progression -->
      <div class="calib-progress">
        <div class="calib-progress-bar" id="calib-progress-bar"></div>
      </div>
      <div class="calib-progress-text" id="calib-progress-text">Ã‰tape 1/5</div>
      
      <!-- Ã‰tape 1: Choix du mode -->
      <div class="calib-step" id="calib-step-1">
        <h3>ğŸ“‹ Choix du mode d'Ã©talonnage</h3>
        <p>SÃ©lectionnez la mÃ©thode d'Ã©talonnage adaptÃ©e Ã  vos besoins:</p>
        
        <div class="calib-mode-choice">
          <div class="calib-mode-card">
            <input type="radio" name="calib-mode" value="offset" id="mode-offset" checked>
            <label for="mode-offset">
              <h4>ğŸ“ Offset simple</h4>
              <p>Correction linÃ©aire unique</p>
              <p class="mode-detail">âœ… Rapide et simple<br>âœ… 1 point de mesure<br>âš ï¸ Moins prÃ©cis sur large plage</p>
            </label>
          </div>
          
          <div class="calib-mode-card">
            <input type="radio" name="calib-mode" value="twopoint" id="mode-twopoint">
            <label for="mode-twopoint">
              <h4>ğŸ¯ 2 points</h4>
              <p>Calibration linÃ©aire complÃ¨te</p>
              <p class="mode-detail">âœ… TrÃ¨s prÃ©cis<br>âœ… Compensate la dÃ©rive<br>â±ï¸ 2 points de mesure</p>
            </label>
          </div>
        </div>
        
        <button class="btn btn-success btn-block" onclick="selectCalibrationMode(document.querySelector('input[name=calib-mode]:checked').value === 'twopoint')">
          Suivant â–¶ï¸
        </button>
      </div>
      
      <!-- Ã‰tape 2: Premier point -->
      <div class="calib-step" id="calib-step-2" style="display: none;">
        <h3>ğŸ“ Point de mesure 1</h3>
        <p>Prenez votre premiÃ¨re mesure de rÃ©fÃ©rence</p>
        
        <div class="realtime-monitor">
          <div class="monitor-label">Valeur capteur en temps rÃ©el:</div>
          <div class="monitor-value" id="calib-realtime-value1">--</div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>ğŸ“ Valeur mesurÃ©e avec votre Ã©quipement de rÃ©fÃ©rence:</label>
          <input type="number" step="0.01" id="calib-real-value1" placeholder="Ex: 22.5">
        </div>
        
        <div class="alert alert-info">
          ğŸ’¡ <strong>Conseil:</strong> Attendez que la valeur se stabilise avant de la noter
        </div>
        
        <button class="btn btn-success btn-block" onclick="captureCalibrationPoint(1)">
          âœ… Capturer ce point
        </button>
      </div>
      
      <!-- Ã‰tape 3: DeuxiÃ¨me point (si 2 points) -->
      <div class="calib-step" id="calib-step-3" style="display: none;">
        <h3>ğŸ“ Point de mesure 2</h3>
        <p id="calib-point1-summary">Point 1 capturÃ©</p>
        
        <div class="alert alert-warning">
          âš ï¸ <strong>Important:</strong> Changez significativement la valeur (Â±10Â°C ou Â±1 bar minimum)
        </div>
        
        <div class="realtime-monitor">
          <div class="monitor-label">Valeur capteur en temps rÃ©el:</div>
          <div class="monitor-value" id="calib-realtime-value2">--</div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>ğŸ“ Valeur mesurÃ©e avec votre Ã©quipement de rÃ©fÃ©rence:</label>
          <input type="number" step="0.01" id="calib-real-value2" placeholder="Ex: 15.0">
        </div>
        
        <button class="btn btn-success btn-block" onclick="captureCalibrationPoint(2)">
          âœ… Capturer ce point
        </button>
      </div>
      
      <!-- Ã‰tape 4: Validation -->
      <div class="calib-step" id="calib-step-4" style="display: none;">
        <h3>âœ… Validation</h3>
        <p>VÃ©rifiez les paramÃ¨tres avant d'appliquer l'Ã©talonnage:</p>
        
        <div id="calib-summary"></div>
        
        <div class="alert alert-warning">
          âš ï¸ L'Ã©talonnage sera appliquÃ© immÃ©diatement. Assurez-vous que les valeurs sont correctes.
        </div>
        
        <div class="form-actions">
          <button class="btn" onclick="closeCalibrationAssistant()">Annuler</button>
          <button class="btn btn-success" onclick="applyCalibration()">âœ… Appliquer</button>
        </div>
      </div>
      
      <!-- Ã‰tape 5: Test -->
      <div class="calib-step" id="calib-step-5" style="display: none;">
        <h3>ğŸ§ª Test de validation</h3>
        <p>L'Ã©talonnage a Ã©tÃ© appliquÃ© avec succÃ¨s. Test de stabilitÃ© en cours...</p>
        
        <div id="calib-test-results">
          <p>ğŸ”„ Test en cours...</p>
        </div>
        
        <div class="form-actions" style="margin-top: 20px;">
          <button class="btn btn-success btn-block" onclick="closeCalibrationAssistant()">
            âœ… Terminer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

  <script src="/app.js"></script>
  <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">ğŸŒ™</button>
</body>
</html>